# RDB和AOF

## redis的持久化方式

1. **RDB (Redis Database)**:
   - **工作原理**: RDB是Redis的默认持久化方式，它在指定的时间间隔内（通过`save`或`bgrewriteaof`配置触发），对当前内存中的数据进行一次全量的快照（snapshot）存储到磁盘上，生成`.rdb`格式的二进制文件。每当Redis需要做持久化时，会fork一个子进程，子进程负责将数据写入硬盘，而主进程则继续处理客户端请求。
   - **优缺点**: RDB文件紧凑，恢复速度快；但是因为是定时或者满足一定条件才进行持久化，所以如果在这段时间内发生故障，可能会丢失最后一次持久化以来的数据。
2. **AOF (Append-only File)**:
   - **工作原理**: AOF持久化方式会记录每一个写命令到AOF文件中，当Redis重启时，会按照AOF文件中的命令顺序重新执行一遍，以恢复数据。另外，AOF还有Rewrite机制，当AOF文件过大时，Redis可以通过BgRewriteAOF后台操作来重写AOF文件，将多个命令合并成一条，优化文件大小。
   - **优缺点**: AOF持久化方式可以提供更高的数据安全性，数据丢失的可能性较小；但由于每一次写操作都需要记录到AOF文件中，所以AOF文件通常比RDB文件更大，恢复速度相较于RDB略慢。不过，Redis提供了不同的AOF同步策略，可以平衡数据安全性与性能。

## AOF的同步策略

1. **always**：
   - 同步策略最为保守，每次写入操作都会调用`fsync()`同步命令将AOF缓冲区的内容强制刷入磁盘。这样做的好处是数据安全性最高，因为每次写操作后都能立即确保数据已经持久化，但代价是性能影响最大，因为`fsync()`调用会导致I/O阻塞。
2. **everysec**（默认设置）：
   - 每秒同步一次。Redis每隔一秒左右会调用一次`fsync()`将AOF缓冲区内容刷入磁盘。这种策略在大多数情况下既能保证数据安全性（最多损失一秒的数据），又能保证较好的性能。即使在服务器崩溃时，最多只会丢失最近一秒的数据。
3. **no**：
   - 异步写入，Redis只负责将命令追加到AOF缓冲区，由操作系统自行决定何时将缓冲区内容同步到磁盘。这种策略提供了最高的写入性能，但数据安全性最低，因为如果服务器突然宕机，AOF缓冲区中尚未同步到磁盘的数据将会丢失。

## AOF中冗余的日志如何处理

在Redis的AOF（Append Only File）持久化模式下，随着写操作的不断增加，AOF日志文件可能会变得越来越大。为了避免文件过大，Redis提供了AOF重写（AOF Rewriting）功能来清除冗余的日志记录，并压缩AOF文件的大小。

AOF重写机制主要包括以下步骤：

1. **触发重写**：
   你可以手动触发重写，也可以配置Redis自动在满足一定条件时触发重写，如文件大小增长超过某个阈值。
2. **创建临时文件**：
   当重写触发时，Redis会创建一个新的临时AOF文件，并在这个新的文件中，基于当前内存中的数据状态，只写出重建当前数据库状态所需的最小命令集。这个过程中，Redis会分析现有的键值对，去除无效命令（如已被撤销的操作），并对多个连续的写操作进行合并，减少文件大小。
3. **替换原有文件**：
   当新的临时AOF文件生成完毕后，Redis会用新的文件替换掉旧的AOF文件，这个过程中Redis会先将新的AOF文件原子地改名为旧的AOF文件名，然后终止使用旧文件。这样，在服务不停止的情况下完成AOF文件的替换。
4. **追加后续命令**：
   替换文件之后，Redis将继续将后续的写命令追加到新的AOF文件中。

